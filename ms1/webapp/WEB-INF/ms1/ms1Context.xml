<?xml version="1.0" encoding="UTF-8"?>
<beans xmlns="http://www.springframework.org/schema/beans"
       xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"
       xsi:schemaLocation="http://www.springframework.org/schema/beans http://www.springframework.org/schema/beans/spring-beans-2.0.xsd">

    <bean id="ms1PipelineRegistry" class="org.labkey.api.pipeline.TaskPipelineRegistrar">
        <property name="pipelines">
            <list>
                <bean class="org.labkey.api.pipeline.file.FileAnalysisTaskPipelineSettings">
                    <constructor-arg value="ms1FeaturePipeline"/>
                    <property name="description" value="msInspect Find Features"/>
                    <property name="protocolObjectId" value="MS1.msInspectFeatureFindingAnalysis" />
                    <property name="protocolName" value="msInspect Feature Finding Analysis" />
                    <property name="protocolFactoryName" value="inspect"/>
                    <property name="sharedOutputExts">
                        <list>
                            <value>.mzXML</value>
                            <value>.mzXML.inspect</value>
                            <value>.mzXML.ms2.tsv</value>
                        </list>
                    </property>
                    <property name="xarGeneratorSupport">
                        <bean class="org.labkey.ms1.pipeline.MSInspectXarGeneratorSupport$Features"/>
                    </property>
                    <property name="taskProgressionSpec">
                        <list>
                            <ref bean="mzxmlConverterId"/>
<!--                            <ref bean="peakabooFactory"/> -->
                            <ref bean="msInspectFactory"/>
                            <ref bean="expGenerator"/>
                        </list>
                    </property>
                </bean>
                
                <bean class="org.labkey.api.pipeline.file.FileAnalysisTaskPipelineSettings">
                    <constructor-arg value="ms1FeaturePeptidePipeline"/>
                    <property name="description" value="msInspect Find Features and Match Peptides"/>
                    <property name="protocolObjectId" value="MS1.msInspectFeaturePeptideMatchingAnalysis" />
                    <property name="protocolName" value="msInspect Feature Peptide Matching Analysis" />
                    <property name="protocolFactoryName" value="pepmatch"/>
                    <property name="initialInputExt" value=".pep.xml"/>
                    <property name="fileExtHierarchy">
                        <map>
                            <entry key=".mzXML">
                                <list><value>.pep.xml</value></list>
                            </entry>
                            <entry key=".mzXML.inspect">
                                <list><value>.pep.xml</value></list>
                            </entry>
                            <entry key=".mzXML.ms2.tsv">
                                <list><value>.pep.xml</value></list>
                            </entry>
                        </map>
                    </property>
                    <property name="sharedOutputExts">
                        <list>
                            <value>.mzXML.inspect</value>
                            <value>.mzXML.ms2.tsv</value>
                        </list>
                    </property>
                    <property name="xarGeneratorSupport">
                        <bean class="org.labkey.ms1.pipeline.MSInspectXarGeneratorSupport$Peptides"/>
                    </property>
                    <property name="taskProgressionSpec">
                        <list>
<!--                            <ref bean="peakabooFactory"/> -->
                            <ref bean="msInspectFactory"/>
                            <ref bean="pepMatchFactory"/>
                            <ref bean="expGenerator"/>
                        </list>
                    </property>
                </bean>
            </list>
        </property>
    </bean>

    <bean id="mzxmlConverterId" class="org.labkey.api.pipeline.TaskId">
        <constructor-arg><value type="java.lang.Class">org.labkey.api.pipeline.cmd.ConvertTaskId</value></constructor-arg>
        <constructor-arg value="mzxmlConverter"/>
    </bean>

    <bean id="unixCompactSwitch" class="org.labkey.api.pipeline.cmd.UnixCompactSwitchFormat"/>
    <bean id="unixNewSwitch" class="org.labkey.api.pipeline.cmd.UnixNewSwitchFormat"/>
    <bean id="unixMixedSwitch" class="org.labkey.api.pipeline.cmd.UnixNewSwitchFormat">
        <property name="separator" value=" "/>
    </bean>

    <bean id="gtOne" class="org.labkey.api.pipeline.cmd.ValidateNumber">
        <property name="min" value="1"/>
    </bean>

    <bean id="expGenerator" class="org.labkey.api.exp.pipeline.XarGeneratorFactorySettings">
        <property name="outputExt" value=".ms1.xar.xml"/>
    </bean>

    <bean id="peakabooFactory" class="org.labkey.api.pipeline.cmd.CommandTaskFactorySettings">
        <constructor-arg value="peakabooFactory"/>
        <property name="statusName" value="PEAK EXTRACTION"/>
        <property name="groupParameterName" value="peakaboo" />
        <property name="protocolActionName" value="Peakaboo" />
        <property name="inputExtension" value=".mzXML"/>
        <property name="outputExtension" value=".peaks.xml"/>
        <property name="switchFormat" ref="unixMixedSwitch"/>
        <property name="converters">
            <list>
                <bean class="org.labkey.api.pipeline.cmd.ExeToCommandArgs">
                    <property name="exePath" value="peakaboo"/>
                </bean>
                <bean class="org.labkey.api.pipeline.cmd.ValueWithSwitch">
                    <property name="parameter" value="peakaboo, start scan"/>
                    <property name="switchName" value="scanBegin"/>
                    <property name="help" value="Minimum scan number (default 1)"/>
                    <property name="paramValidator" ref="gtOne"/>
                </bean>
                <bean class="org.labkey.api.pipeline.cmd.ValueWithSwitch">
                    <property name="parameter" value="peakaboo, end scan"/>
                    <property name="switchName" value="scanEnd"/>
                    <property name="help" value="Maximum scan number (default last)"/>
                    <property name="paramValidator">
                        <bean class="org.labkey.api.pipeline.cmd.ValidateNumber">
                            <property name="minParamName" value="peakaboo, start scan"/>
                        </bean>
                    </property>
                </bean>
                <bean class="org.labkey.api.pipeline.cmd.ValueWithSwitch">
                    <property name="parameter" value="peakaboo, minimum m/z"/>
                    <property name="switchName" value="mzLow"/>
                    <property name="help" value="Minimum M/Z Value (default: the minimum m/z value in the file)"/>
                    <property name="paramValidator">
                        <!-- todo: minimum and maximum values? -->
                        <bean class="org.labkey.api.pipeline.cmd.ValidateDecimal">
                            <property name="maxParamName" value="peakaboo, maximum m/z"/>
                        </bean>
                    </property>
                </bean>
                <bean class="org.labkey.api.pipeline.cmd.ValueWithSwitch">
                    <property name="parameter" value="peakaboo, maximum m/z"/>
                    <property name="switchName" value="mzHigh"/>
                    <property name="help" value="Maximum M/Z Value (default: the maximum m/z value in the file)"/>
                    <property name="paramValidator">
                        <!-- todo: minimum and maximum values? -->
                        <bean class="org.labkey.api.pipeline.cmd.ValidateDecimal">
                            <property name="minParamName" value="peakaboo, minimum m/z"/>
                        </bean>
                    </property>
                </bean>
                <bean class="org.labkey.api.pipeline.cmd.ExtWithSwitch">
                    <property name="function" value="output"/>
                    <property name="switchName" value="e"/>                    
                </bean>
                <bean class="org.labkey.api.pipeline.cmd.PathInLine"/>
            </list>
        </property>
    </bean>

    <bean id="msInspectFactory" class="org.labkey.api.pipeline.cmd.CommandTaskFactorySettings">
        <constructor-arg value="msInspectFactory"/>
        <property name="statusName" value="FIND FEATURES"/>
        <property name="groupParameterName" value="msinspect" />
        <property name="protocolActionName" value="msInspect Find Features" />
        <property name="inputExtension" value=".mzXML"/>
        <property name="outputExtension" value=".peptides.tsv"/>
        <property name="inputPaths">
            <map>
                <entry key="input">
                    <bean class="org.labkey.api.pipeline.cmd.TaskPath">
                        <constructor-arg value=".mzXML"/>
                        <property name="role" value="mzXML" />
                    </bean>
                </entry>
                <entry key="msInspectDefFile">
                    <bean class="org.labkey.api.pipeline.cmd.TaskPath">
                        <constructor-arg>
                            <bean class="org.labkey.api.util.FileType">
                                <constructor-arg value="inspect.xml" />
                                <property name="includeBasename" value="false" />
                            </bean>
                        </constructor-arg>
                        <property name="role" value="msInspectDefFile" />
                    </bean>
                </entry>
            </map>
        </property>
        <property name="outputPaths">
            <map>
                <entry key="output-cache">
                    <bean class="org.labkey.api.pipeline.cmd.TaskPath">
                        <constructor-arg value=".mzXML.inspect"/>
                    </bean>
                </entry>
                <entry key="output-ms2">
                    <bean class="org.labkey.api.pipeline.cmd.TaskPath">
                        <constructor-arg value=".mzXML.ms2.tsv"/>
                    </bean>
                </entry>
            </map>
        </property>
        <property name="switchFormat" ref="unixNewSwitch"/>
        <property name="converters">
            <list>
                <bean class="org.labkey.api.pipeline.cmd.JarToCommandArgs">
                    <property name="softwarePackage" value="msinspect"/>
                    <property name="jarPath" value="viewerApp${version}.jar"/>
                    <property name="converters">
                        <list>
                            <bean class="org.labkey.api.pipeline.cmd.RequiredSwitch">
                                <property name="switchName" value="Xmx"/>
                                <property name="value" value="1024M"/>
                            </bean>
                        </list>
                    </property>
                </bean>
                <bean class="org.labkey.api.pipeline.cmd.RequiredSwitch">
                    <property name="switchName" value="findpeptides"/>
                </bean>
                <bean class="org.labkey.api.pipeline.cmd.ValueWithSwitch">
                    <property name="parameter" value="msinspect findpeptides, start scan"/>
                    <property name="switchName" value="start"/>
                    <property name="help" value="Minimum scan number (default 1)"/>
                    <property name="paramValidator" ref="gtOne"/>
                </bean>
                <bean class="org.labkey.api.pipeline.cmd.ValueWithSwitch">
                    <property name="parameter" value="msinspect findpeptides, scan count"/>
                    <property name="switchName" value="count"/>
                    <property name="help" value="Number of scans to search, if not all"/>
                    <property name="paramValidator" ref="gtOne"/>
                </bean>
<!--           No longer used
               <bean class="org.labkey.api.pipeline.cmd.ValueWithSwitch">
                    <property name="parameter" value="msinspect findpeptides, dump window"/>
                    <property name="switchName" value="dumpwindow"/>
                    <property name="help" value="Number of scans around each feature to dump to the file"/>
                    <property name="paramValidator" ref="gtOne"/>
                </bean>
-->
                <bean class="org.labkey.api.pipeline.cmd.ValueWithSwitch">
                    <property name="parameter" value="msinstpect findpeptides, minimum m/z"/>
                    <property name="switchName" value="minmz"/>
                    <property name="help" value="Minimum M/Z Value (default: the minimum m/z value in the file)"/>
                    <property name="paramValidator">
                        <!-- todo: minimum and maximum values? -->
                        <bean class="org.labkey.api.pipeline.cmd.ValidateDecimal">
                            <property name="maxParamName" value="msinspect findpeptides, maximum m/z"/>
                        </bean>
                    </property>
                </bean>
                <bean class="org.labkey.api.pipeline.cmd.ValueWithSwitch">
                    <property name="parameter" value="msinspect findpeptides, maximum m/z"/>
                    <property name="switchName" value="maxmz"/>
                    <property name="help" value="Maximum M/Z Value (default: the maximum m/z value in the file)"/>
                    <property name="paramValidator">
                        <!-- todo: minimum and maximum values? -->
                        <bean class="org.labkey.api.pipeline.cmd.ValidateDecimal">
                            <property name="minParamName" value="msinspect findpeptides, minimum m/z"/>
                        </bean>
                    </property>
                </bean>
                <bean class="org.labkey.api.pipeline.cmd.ValueWithSwitch">
                    <property name="parameter" value="msinspect findpeptides, strategy"/>
                    <property name="switchName" value="strategy"/>
                    <property name="help" value="Class name of a feature-finding strategy implementation"/>
                </bean>
                <bean class="org.labkey.api.pipeline.cmd.ValueWithSwitch">
                    <property name="parameter" value="msinspect findpeptides, accurate mass scans"/>
                    <property name="switchName" value="accuratemassscans"/>
                    <property name="help" value="When attempting to improve mass-accuracy, consider a neighborhood of n scans"/>
                </bean>
                <bean class="org.labkey.api.pipeline.cmd.BooleanToSwitch">
                    <property name="parameter" value="msinspect findpeptides, no accurate mass"/>
                    <property name="switchName" value="noaccuratemass"/>
                    <property name="help" value="Do not attempt mass-accuracy adjustment after default peak finding strategy"/>
                </bean>
                <bean class="org.labkey.api.pipeline.cmd.BooleanToSwitch">
                    <property name="parameter" value="msinspect findpeptides, walk smoothed"/>
                    <property name="switchName" value="walksmoothed"/>
                    <property name="help" value="When calculating feature extents, use smoothed rather than wavelet-transformed spectra"/>
                </bean>
                <bean class="org.labkey.api.pipeline.cmd.PathWithSwitch">
                    <property name="function" value="output"/>
                    <property name="switchName" value="out"/>                    
                </bean>
                <bean class="org.labkey.api.pipeline.cmd.PathInLine"/>
            </list>
        </property>
    </bean>

    <bean id="pepMatchFactory" class="org.labkey.api.pipeline.cmd.CommandTaskFactorySettings">
        <constructor-arg value="pepMatchFactory"/>
        <property name="statusName" value="MATCH PEPTIDES"/>
        <property name="groupParameterName" value="ms1 pepmatch" />
        <property name="protocolActionName" value="MS1-MS2 Peptide Matching" />
        <property name="removeInput" value="true"/>
        <property name="inputPaths">
            <map>
                <entry key="input">
                    <bean class="org.labkey.api.pipeline.cmd.TaskPath">
                        <constructor-arg value=".peptides.tsv"/>
                        <property name="role" value="Features" />
                    </bean>
                </entry>
                <entry key="input-peptides">
                    <bean class="org.labkey.api.pipeline.cmd.TaskPath">
                        <constructor-arg value=".pep.xml"/>
                        <property name="role" value="pepXML" />
                    </bean>
                </entry>
            </map>
        </property>
        <property name="outputExtension" value=".pepmatch.tsv"/>
        <property name="switchFormat" ref="unixCompactSwitch"/>
        <property name="converters">
            <list>
                <bean class="org.labkey.api.pipeline.cmd.ExeToCommandArgs">
                    <property name="softwarePackage" value="tpp"/>
                    <property name="exePath" value="pepmatch"/>
                </bean>
                <bean class="org.labkey.api.pipeline.cmd.PathInLine">
                    <property name="key" value="input-peptides"/>
                </bean>
                <bean class="org.labkey.api.pipeline.cmd.PathInLine"/>
                <bean class="org.labkey.api.pipeline.cmd.ValueWithSwitch">
                    <property name="parameter" value="ms1 pepmatch, m/z window"/>
                    <property name="switchName" value="w"/>
                    <property name="help" value="Filters on the specified m/z-delta window (default 1.0)"/>
                    <property name="paramValidator">
                        <bean class="org.labkey.api.pipeline.cmd.ValidateDecimal"/>
                    </property>
                </bean>
                <bean class="org.labkey.api.pipeline.cmd.ValueWithSwitch">
                    <property name="parameter" value="ms1 pepmatch, min probability"/>
                    <property name="switchName" value="p"/>
                    <property name="help" value="Minimum PeptideProphet probability to match"/>
                    <property name="paramValidator">
                        <bean class="org.labkey.api.pipeline.cmd.ValidateDecimal">
                            <property name="max" value="1.0"/>
                            <property name="min" value="0.0"/>
                        </bean>
                    </property>
                </bean>
                <bean class="org.labkey.api.pipeline.cmd.BooleanToSwitch">
                    <property name="parameter" value="ms1 pepmatch, require charge match"/>
                    <property name="switchName" value="c"/>
                    <property name="help" value="Discard matches where pepXML assumed charge does not match MS1 data"/>
                </bean>
                <bean class="org.labkey.api.pipeline.cmd.PathWithSwitch">
                    <property name="function" value="output"/>
                    <property name="switchName" value="o"/>
                </bean>
            </list>
        </property>
    </bean>
</beans>