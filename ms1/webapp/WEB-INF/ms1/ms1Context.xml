<!DOCTYPE beans PUBLIC "-//SPRING//DTD BEAN//EN" "http://www.springframework.org/dtd/spring-beans.dtd">

<beans>
    <bean id="ms1PipelineRegistry" class="org.labkey.api.pipeline.TaskPipelineRegistrar">
        <property name="pipelines">
            <list>
                <bean class="org.labkey.api.pipeline.file.FileAnalysisTaskPipelineSettings">
                    <constructor-arg value="ms1FeaturePipeline"/>
                    <property name="description" value="Find MS1 Features"/>
                    <property name="protocolFactoryName" value="inspect"/>
                    <!-- bogus XAR file for this pipeline -->
                    <property name="xarGeneratorSupport">
                        <bean class="org.labkey.ms1.pipeline.MSInspectXarGeneratorSupport"/>
                    </property>
                    <property name="taskProgressionSpec">
                        <list>
                            <ref bean="msInspectFactory"/>
                            <ref bean="expGeneratorFeatures"/>
                            <value type="java.lang.Class">org.labkey.api.exp.pipeline.XarImportTaskId</value>
                        </list>
                    </property>
                </bean>
                
                <bean class="org.labkey.api.pipeline.file.FileAnalysisTaskPipelineSettings">
                    <constructor-arg value="ms1FeaturePeptidePipeline"/>
                    <property name="description" value="Match MS1 Features to Peptides"/>
                    <property name="protocolFactoryName" value="ms1peptides"/>
                    <property name="initialInputExt" value=".pep.xml"/>
                    <property name="inputExtHeirarchy">
                        <map>
                            <entry key=".mzXML">
                                <list><value>.pep.xml</value></list>
                            </entry>
                        </map>
                    </property>
                    <property name="xarGeneratorSupport">
                        <bean class="org.labkey.ms1.pipeline.MSInspectXarGeneratorSupport"/>
                    </property>
                    <property name="taskProgressionSpec">
                        <list>
<!--                            <ref bean="peakabooFactory"/> -->
                            <ref bean="msInspectFactory"/>
                            <ref bean="ms1PeptideParserFactory"/>
                            <ref bean="expGeneratorPeptides"/>
                            <value type="java.lang.Class">org.labkey.api.exp.pipeline.XarImportTaskId</value>
                        </list>
                    </property>
                </bean>
            </list>
        </property>
    </bean>

    <bean id="expGeneratorFeatures" class="org.labkey.api.exp.pipeline.XarGeneratorFactorySettings">
        <constructor-arg value="expGeneratorFeatures"/>
        <property name="inputExt" value=".features.tsv"/>
    </bean>

    <bean id="expGeneratorPeptides" class="org.labkey.api.exp.pipeline.XarGeneratorFactorySettings">
        <constructor-arg value="expGeneratorPeptides"/>
        <property name="inputExt" value=".peptides.tsv"/>
    </bean>

    <bean id="unixCompactSwitch" class="org.labkey.api.pipeline.cmd.UnixCompactSwitchFormat"/>
    <bean id="unixNewSwitch" class="org.labkey.api.pipeline.cmd.UnixNewSwitchFormat"/>
    <bean id="unixMixedSwitch" class="org.labkey.api.pipeline.cmd.UnixNewSwitchFormat">
        <property name="separator" value=" "/>
    </bean>

    <bean id="gtOne" class="org.labkey.api.pipeline.cmd.ValidateNumber">
        <property name="min" value="1"/>
    </bean>
    
    <bean id="peakabooFactory" class="org.labkey.api.pipeline.cmd.CommandTaskFactorySettings">
        <constructor-arg value="peakabooFactory"/>
        <property name="inputExtension" value=".mzXML"/>
        <property name="outputExtension" value=".peaks.xml"/>
        <property name="switchFormat" ref="unixMixedSwitch"/>
        <property name="converters">
            <list>
                <bean class="org.labkey.api.pipeline.cmd.RequiredInLine">
                    <property name="value" value="peakaboo"/>
                </bean>
                <bean class="org.labkey.api.pipeline.cmd.ValueWithSwitch">
                    <property name="parameter" value="ms1 peaks, start scan"/>
                    <property name="switchName" value="scanBegin"/>
                    <property name="help" value="Minimum scan number (default 1)"/>
                    <property name="paramValidator" ref="gtOne"/>
                </bean>
                <bean class="org.labkey.api.pipeline.cmd.ValueWithSwitch">
                    <property name="parameter" value="ms1 peaks, end scan"/>
                    <property name="switchName" value="scanEnd"/>
                    <property name="help" value="Maximum scan number (default last)"/>
                    <property name="paramValidator">
                        <bean class="org.labkey.api.pipeline.cmd.ValidateNumber">
                            <property name="minParamName" value="ms1 peaks, start scan"/>
                        </bean>
                    </property>
                </bean>
                <bean class="org.labkey.api.pipeline.cmd.ValueWithSwitch">
                    <property name="parameter" value="ms1 peaks, minimum m/z"/>
                    <property name="switchName" value="mzLow"/>
                    <property name="help" value="Minimum M/Z Value (default: the minimum m/z value in the file)"/>
                    <property name="paramValidator">
                        <!-- todo: minimum and maximum values? -->
                        <bean class="org.labkey.api.pipeline.cmd.ValidateDecimal">
                            <property name="maxParamName" value="ms1 peaks, maximum m/z"/>
                        </bean>
                    </property>
                </bean>
                <bean class="org.labkey.api.pipeline.cmd.ValueWithSwitch">
                    <property name="parameter" value="ms1 peaks, maximum m/z"/>
                    <property name="switchName" value="mzHigh"/>
                    <property name="help" value="Maximum M/Z Value (default: the maximum m/z value in the file)"/>
                    <property name="paramValidator">
                        <!-- todo: minimum and maximum values? -->
                        <bean class="org.labkey.api.pipeline.cmd.ValidateDecimal">
                            <property name="minParamName" value="ms1 peaks, minimum m/z"/>
                        </bean>
                    </property>
                </bean>
                <bean class="org.labkey.api.pipeline.cmd.ExtWithSwitch">
                    <property name="function" value="output"/>
                    <property name="switchName" value="e"/>                    
                </bean>
                <bean class="org.labkey.api.pipeline.cmd.PathInLine"/>
            </list>
        </property>
    </bean>

    <bean id="msInspectFactory" class="org.labkey.api.pipeline.cmd.CommandTaskFactorySettings">
        <constructor-arg value="msInspectFactory"/>
        <property name="inputExtension" value=".mzXML"/>
        <property name="outputExtension" value=".features.tsv"/>
        <property name="switchFormat" ref="unixNewSwitch"/>
        <property name="converters">
            <list>
                <bean class="org.labkey.api.pipeline.cmd.JarToCommandArgs">
                    <property name="jarPath" value="viewerApp.jar"/>
                </bean>
                <bean class="org.labkey.api.pipeline.cmd.RequiredSwitch">
                    <property name="switchName" value="findpeptides"/>
                </bean>
                <bean class="org.labkey.api.pipeline.cmd.ValueWithSwitch">
                    <property name="parameter" value="ms1 findpeptides, start scan"/>
                    <property name="switchName" value="start"/>
                    <property name="help" value="Minimum scan number (default 1)"/>
                    <property name="paramValidator" ref="gtOne"/>
                </bean>
                <bean class="org.labkey.api.pipeline.cmd.ValueWithSwitch">
                    <property name="parameter" value="ms1 findpeptides, scan count"/>
                    <property name="switchName" value="count"/>
                    <property name="help" value="Number of scans to search, if not all"/>
                    <property name="paramValidator" ref="gtOne"/>
                </bean>
                <bean class="org.labkey.api.pipeline.cmd.ValueWithSwitch">
                    <property name="parameter" value="ms1 findpeptides, dump window"/>
                    <property name="switchName" value="dumpwindow"/>
                    <property name="help" value="Number of scans around each feature to dump to the file"/>
                    <property name="paramValidator" ref="gtOne"/>
                </bean>
                <bean class="org.labkey.api.pipeline.cmd.ValueWithSwitch">
                    <property name="parameter" value="ms1 findpeptides, minimum m/z"/>
                    <property name="switchName" value="minmz"/>
                    <property name="help" value="Minimum M/Z Value (default: the minimum m/z value in the file)"/>
                    <property name="paramValidator">
                        <!-- todo: minimum and maximum values? -->
                        <bean class="org.labkey.api.pipeline.cmd.ValidateDecimal">
                            <property name="maxParamName" value="ms1 findpeptides, maximum m/z"/>
                        </bean>
                    </property>
                </bean>
                <bean class="org.labkey.api.pipeline.cmd.ValueWithSwitch">
                    <property name="parameter" value="ms1 findpeptides, maximum m/z"/>
                    <property name="switchName" value="maxmz"/>
                    <property name="help" value="Maximum M/Z Value (default: the maximum m/z value in the file)"/>
                    <property name="paramValidator">
                        <!-- todo: minimum and maximum values? -->
                        <bean class="org.labkey.api.pipeline.cmd.ValidateDecimal">
                            <property name="minParamName" value="ms1 findpeptides, minimum m/z"/>
                        </bean>
                    </property>
                </bean>
                <bean class="org.labkey.api.pipeline.cmd.ValueWithSwitch">
                    <property name="parameter" value="ms1 findpeptides, strategy"/>
                    <property name="switchName" value="strategy"/>
                    <property name="help" value="Class name of a feature-finding strategy implementation"/>
                </bean>
                <bean class="org.labkey.api.pipeline.cmd.ValueWithSwitch">
                    <property name="parameter" value="ms1 findpeptides, accurate mass scans"/>
                    <property name="switchName" value="accuratemassscans"/>
                    <property name="help" value="When attempting to improve mass-accuracy, consider a neighborhood of n scans"/>
                </bean>
                <bean class="org.labkey.api.pipeline.cmd.BooleanToSwitch">
                    <property name="parameter" value="ms1 findpeptides, no accurate mass"/>
                    <property name="switchName" value="noaccuratemass"/>
                    <property name="help" value="Do not attempt mass-accuracy adjustment after default peak finding strategy"/>
                </bean>
                <bean class="org.labkey.api.pipeline.cmd.BooleanToSwitch">
                    <property name="parameter" value="ms1 findpeptides, walk smoothed"/>
                    <property name="switchName" value="walksmoothed"/>
                    <property name="help" value="When calculating feature extents, use smoothed rather than wavelet-transformed spectra)"/>
                </bean>
                <bean class="org.labkey.api.pipeline.cmd.PathWithSwitch">
                    <property name="function" value="output"/>
                    <property name="switchName" value="out"/>                    
                </bean>
                <bean class="org.labkey.api.pipeline.cmd.PathInLine"/>
            </list>
        </property>
    </bean>

    <bean id="ms1PeptideParserFactory" class="org.labkey.api.pipeline.cmd.CommandTaskFactorySettings">
        <constructor-arg value="ms1PeptideParserFactory"/>
        <property name="removeInput" value="true"/>
        <property name="inputExtension" value=".features.tsv"/>
        <property name="inputPaths">
            <map>
                <entry key="input-peptides">
                    <bean class="org.labkey.api.pipeline.cmd.TaskPath">
                        <constructor-arg value=".pep.xml"/>
                    </bean>
                </entry>
            </map>
        </property>
        <property name="outputExtension" value=".peptides.tsv"/>
        <property name="switchFormat" ref="unixCompactSwitch"/>
        <property name="converters">
            <list>
                <bean class="org.labkey.api.pipeline.cmd.RequiredInLine">
                    <property name="value" value="MS1PeptideParser"/>
                </bean>
                <bean class="org.labkey.api.pipeline.cmd.PathInLine">
                    <property name="key" value="input-peptides"/>
                </bean>
                <bean class="org.labkey.api.pipeline.cmd.PathInLine"/>
                <bean class="org.labkey.api.pipeline.cmd.ValueWithSwitch">
                    <property name="parameter" value="ms1 peptides, window"/>
                    <property name="switchName" value="w"/>
                    <property name="help" value="Filters on the specified mz-delta window"/>
                    <property name="paramValidator">
                        <bean class="org.labkey.api.pipeline.cmd.ValidateDecimal"/>
                    </property>
                </bean>
                <bean class="org.labkey.api.pipeline.cmd.PathWithSwitch">
                    <property name="function" value="output"/>
                    <property name="switchName" value="o"/>
                </bean>
            </list>
        </property>
    </bean>
</beans>