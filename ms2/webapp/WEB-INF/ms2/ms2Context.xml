<?xml version="1.0" encoding="UTF-8"?>
<beans xmlns="http://www.springframework.org/schema/beans"
       xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"
       xsi:schemaLocation="http://www.springframework.org/schema/beans http://www.springframework.org/schema/beans/spring-beans-2.0.xsd">

    <bean id="ms2PipelineRegistry" class="org.labkey.api.pipeline.TaskPipelineRegistrar">
        <property name="factoryImpls">
            <list>
                <bean class="org.labkey.ms2.pipeline.FastaCheckTask$Factory"/>
                <bean class="org.labkey.ms2.pipeline.tandem.XTandemSearchTask$Factory">
                    <property name="inputTypes">
                        <list>
                            <ref bean="mzXMLFileType" />
                        </list>
                    </property>
                </bean>
                <bean class="org.labkey.ms2.pipeline.mascot.MascotSearchTask$Factory">
                    <property name="inputTypes">
                        <list>
                            <ref bean="mzXMLFileType" />
                        </list>
                    </property>
                </bean>
                <bean class="org.labkey.ms2.pipeline.sequest.SequestSearchTask$Factory">
                    <property name="inputTypes">
                        <list>
                            <ref bean="mzXMLFileType" />
                        </list>
                    </property>
                </bean>
                <bean class="org.labkey.ms2.pipeline.TPPTask$Factory"/>
                <bean class="org.labkey.ms2.pipeline.TPPTask$FactoryJoin"/>
            </list>
        </property>
        <property name="factories">
            <list>
                <ref bean="readwMzxmlConverter"/>
                <ref bean="expGeneratorSearch"/>
                <ref bean="expGeneratorSearchJoin"/>
                <ref bean="expTemplateSearch"/>
                <ref bean="expTemplateSearchJoin"/>
                <ref bean="expImportSearch"/>
                <ref bean="expImportSearchJoin"/>
                <ref bean="msPrefixCommand"/>
            </list>
        </property>
        <property name="pipelines">
            <list>
                <!-- X! Tandem search pipeline -->
                <bean class="org.labkey.api.pipeline.TaskPipelineSettings">
                    <constructor-arg type="java.lang.Class" value="org.labkey.ms2.pipeline.tandem.XTandemPipelineJob"/>
                    <property name="protocolObjectId" value="MS2.XTandemSearch" />
                    <property name="protocolName" value="X!Tandem analysis" />
                    <property name="taskProgressionSpec">
                        <list>
                            <value type="java.lang.Class">org.labkey.ms2.pipeline.FastaCheckTask</value>
                            <ref bean="mzxmlConverter"/>
                            <ref bean="msPrefixCommand"/>
                            <value type="java.lang.Class">org.labkey.ms2.pipeline.tandem.XTandemSearchTask</value>
                            <ref bean="tppTask"/>
                            <ref bean="expGeneratorSearch"/>
                            <ref bean="tppTaskJoin"/>
                            <ref bean="expGeneratorSearchJoin"/>
                        </list>
                    </property>
                </bean>

                <!-- Mascot search pipelines -->
                <bean class="org.labkey.api.pipeline.TaskPipelineSettings">
                    <constructor-arg type="java.lang.Class" value="org.labkey.ms2.pipeline.mascot.MascotPipelineJob"/>
                    <property name="protocolObjectId" value="MS2.MascotSearch" />
                    <property name="protocolName" value="Mascot analysis" />
                    <property name="taskProgressionSpec">
                        <list>
                            <value type="java.lang.Class">org.labkey.ms2.pipeline.FastaCheckTask</value>
                            <ref bean="mzxmlConverter"/>
                            <ref bean="msPrefixCommand"/>
                            <value type="java.lang.Class">org.labkey.ms2.pipeline.mascot.MascotSearchTask</value>
                            <ref bean="tppTask"/>
                            <ref bean="expGeneratorSearch"/>
                            <ref bean="tppTaskJoin"/>
                            <ref bean="expGeneratorSearchJoin"/>
                        </list>
                    </property>
                </bean>

                <!-- Sequest search pipelines -->
                <bean class="org.labkey.api.pipeline.TaskPipelineSettings">
                    <constructor-arg type="java.lang.Class" value="org.labkey.ms2.pipeline.sequest.SequestPipelineJob"/>
                    <property name="protocolObjectId" value="MS2.SequestSearch" />
                    <property name="protocolName" value="Sequest analysis" />
                    <property name="taskProgressionSpec">
                        <list>
                            <value type="java.lang.Class">org.labkey.ms2.pipeline.FastaCheckTask</value>
                            <ref bean="mzxmlConverter"/>
                            <ref bean="msPrefixCommand"/>
                            <value type="java.lang.Class">org.labkey.ms2.pipeline.sequest.SequestSearchTask</value>
                            <ref bean="tppTask"/>
                            <ref bean="expGeneratorSearch"/>
                            <ref bean="tppTaskJoin"/>
                            <ref bean="expGeneratorSearchJoin"/>
                        </list>
                    </property>
                </bean>

                <!-- MS2 pipeline for finishing a search on the Perl Cluster Pipeline -->
                <bean class="org.labkey.api.pipeline.TaskPipelineSettings">
                    <constructor-arg type="java.lang.Class" value="org.labkey.ms2.pipeline.AbstractMS2SearchPipelineJob"/>
                    <constructor-arg value="finishPerlCluster"/>
                    <property name="taskProgressionSpec">
                        <list>
                            <ref bean="expTemplateSearch"/>
                            <ref bean="expImportSearch"/>
                        </list>
                    </property>
                </bean>

                <!-- MS2 pipeline for finishing a fractions search on the Perl Cluster Pipeline -->
                <bean class="org.labkey.api.pipeline.TaskPipelineSettings">
                    <constructor-arg type="java.lang.Class" value="org.labkey.ms2.pipeline.AbstractMS2SearchPipelineJob"/>
                    <constructor-arg value="finishPerlClusterJoined"/>
                    <property name="taskProgressionSpec">
                        <list>
                            <ref bean="expTemplateSearchJoin"/>
                            <ref bean="expImportSearchJoin"/>
                        </list>
                    </property>
                </bean>
            </list>
        </property>
    </bean>

    <!-- TaskIds for TPP tasks registered in factoryImpls -->
    <bean id="tppTask" class="org.labkey.api.pipeline.TaskId">
        <constructor-arg><value type="java.lang.Class">org.labkey.ms2.pipeline.TPPTask</value></constructor-arg>
    </bean>

    <bean id="tppTaskJoin" class="org.labkey.api.pipeline.TaskId">
        <constructor-arg><value type="java.lang.Class">org.labkey.ms2.pipeline.TPPTask</value></constructor-arg>
        <constructor-arg value="join"/>
    </bean>

    <!-- Experiment derived tasks -->
    <bean id="expGeneratorSearch" class="org.labkey.api.exp.pipeline.XarGeneratorFactorySettings">
        <constructor-arg value="expGeneratorSearch"/>
        <property name="outputExt" value=".search.xar.xml"/>
        <property name="dependencyId" ref="tppTask"/>
    </bean>

    <bean id="expGeneratorSearchJoin" class="org.labkey.api.exp.pipeline.XarGeneratorFactorySettings">
        <constructor-arg value="expGeneratorSearchJoin"/>
        <property name="outputExt" value=".search.xar.xml"/>
        <property name="join" value="true" />
        <property name="dependencyId" ref="tppTaskJoin"/>
    </bean>

    <bean id="expTemplateSearch" class="org.labkey.api.exp.pipeline.XarTemplateSubstitutionFactorySettings">
        <constructor-arg value="expTemplateSearch"/>
        <property name="outputExt" value=".search.xar.xml"/>
        <property name="dependencyId" ref="tppTask"/>
    </bean>

    <bean id="expTemplateSearchJoin" class="org.labkey.api.exp.pipeline.XarTemplateSubstitutionFactorySettings">
        <constructor-arg value="expTemplateSearchJoin"/>
        <property name="outputExt" value=".search.xar.xml"/>
        <property name="join" value="true"/>
        <property name="dependencyId" ref="tppTaskJoin"/>
    </bean>

    <bean id="expImportSearch" class="org.labkey.api.exp.pipeline.XarImportFactorySettings">
        <constructor-arg value="expImportSearch"/>
        <property name="inputExt" value=".search.xar.xml"/>
        <property name="dependencyId" ref="tppTask"/>
    </bean>

    <bean id="expImportSearchJoin" class="org.labkey.api.exp.pipeline.XarImportFactorySettings">
        <constructor-arg value="expImportSearchJoin"/>
        <property name="inputExt" value=".search.xar.xml"/>
        <property name="join" value="true"/>
        <property name="dependencyId" ref="tppTaskJoin"/>
    </bean>

    <!-- mzXML conversion task, which is currently a no-op, since its converters -->
    <!-- property is not set.  You can override this task, and set the converters -->
    <!-- property in ms2Config.xml. -->
    <bean id="mzxmlConverter" class="org.labkey.api.pipeline.cmd.ConvertTaskFactorySettings">
        <constructor-arg value="mzxmlConverter"/>
        <property name="statusName" value="MZXML CONVERSION"/>
        <property name="outputType" ref="mzXMLFileType"/>
        <!-- Add converters in ms2Config.xml to enable -->
    </bean>

    <!-- ReAdW mzXML converter command task -->
    <!-- The default configuration does not use this task.  It is here to simplify enabling the  -->
    <!-- mzxmlConverter task for Thermo RAW to mzXML conversion. -->
    <bean id="readwMzxmlConverter" class="org.labkey.api.pipeline.cmd.CommandTaskFactorySettings">
        <constructor-arg value="readwMzxmlConverter"/>
        <property name="statusName" value="MZXML CONVERSION"/>
        <property name="groupParameterName" value="readw" />
        <property name="protocolActionName" value="ReAdW mzXML Conversion" />
        <property name="outputType" ref="mzXMLFileType" />
        <property name="inputPaths">
            <map>
                <entry key="Spectra">
                    <bean class="org.labkey.api.pipeline.cmd.TaskPath">
                        <constructor-arg value=".RAW"/>
                    </bean>
                </entry>
            </map>
        </property>
        <property name="converters">
            <list>
                <bean class="org.labkey.api.pipeline.cmd.ExeToCommandArgs">
                    <property name="exePath" value="ReAdW${version}"/>
                    <property name="versionParamName" value="pipeline, readw version"/>
                    <property name="softwarePackage" value="mzXML"/>
                </bean>
                <bean class="org.labkey.api.pipeline.cmd.EnumToCommandArgs">
                    <property name="parameter" value="pipeline, readw version"/>
                    <property name="default" value="3.5.1"/>
                    <property name="converters">
                        <map>
                            <entry key="3.5.1">
                                <bean class="org.labkey.api.pipeline.cmd.ListToCommandArgs">
                                    <property name="switchFormat" ref="unixNewSwitch"/>
                                    <property name="converters">
                                        <list>
                                            <bean class="org.labkey.api.pipeline.cmd.RequiredSwitch">
                                                <property name="switchName" value="mzxml"/>
                                            </bean>
                                            <bean class="org.labkey.api.pipeline.cmd.BooleanToSwitch">
                                                <property name="parameter" value="readw, peaklist compression"/>
                                                <property name="switchName" value="compress"/>
                                            </bean>
                                            <bean class="org.labkey.api.pipeline.cmd.BooleanToSwitch">
                                                <property name="parameter" value="readw, verbose"/>
                                                <property name="switchName" value="verbose"/>
                                            </bean>
                                            <bean class="org.labkey.api.pipeline.cmd.PathInLine">
                                                <property name="key" value="Spectra" />
                                            </bean>
                                            <bean class="org.labkey.api.pipeline.cmd.PathInLine">
                                                <property name="function" value="output"/>
                                            </bean>
                                        </list>
                                    </property>
                                </bean>
                            </entry>
                            <entry key="1.2">
                                <bean class="org.labkey.api.pipeline.cmd.ListToCommandArgs">
                                    <property name="converters">
                                        <list>
                                            <bean class="org.labkey.api.pipeline.cmd.PathInLine">
                                                <property name="key" value="Spectra" />
                                            </bean>
                                            <bean class="org.labkey.api.pipeline.cmd.RequiredInLine">
                                                <property name="value" value="p"/>
                                            </bean>
                                        </list>
                                    </property>
                                </bean>                                
                            </entry>
                        </map>
                    </property>
                </bean>
            </list>
        </property>
    </bean>

    <bean id="msPrefixCommand" class="org.labkey.api.pipeline.cmd.CommandTaskFactorySettings">
        <constructor-arg value="msPrefixCommand"/>
        <property name="statusName" value="MS PREFIX"/>
        <property name="groupParameterName" value="msconvert" />
        <property name="protocolActionName" value="msPrefix" />
        <property name="outputExtension" value=".msprefix.mzXML"/>
        <property name="inputPaths">
            <map>
                <entry key="Spectra">
                    <bean class="org.labkey.api.pipeline.cmd.TaskPath">
                        <constructor-arg value=".mzXML"/>
                    </bean>
                </entry>
            </map>
        </property>
        <property name="switchFormat" ref="unixNewSwitch"/>
        <property name="converters">
            <list>
                <bean class="org.labkey.api.pipeline.cmd.EnumToCommandArgs">
                    <property name="parameter" value="pipeline msprefix, enable"/>
                    <property name="default" value="false"/>
                    <property name="converters">
                        <map>
                            <entry key="true">
                                <bean class="org.labkey.api.pipeline.cmd.ListToCommandArgs">
                                    <property name="switchFormat" ref="unixNewSwitch"/>
                                    <property name="converters">
                                        <list>
                                            <bean class="org.labkey.api.pipeline.cmd.ExeToCommandArgs">
                                                <property name="softwarePackage" value="pwiz"/>
                                                <property name="exePath" value="msconvert"/>
                                            </bean>
                                            <bean class="org.labkey.api.pipeline.cmd.RequiredSwitch">
                                                <property name="switchName" value="p"/>
                                                <property name="switchFormat" ref="unixDefaultSwitch" />
                                            </bean>
                                            <bean class="org.labkey.api.pipeline.cmd.RequiredSwitch">
                                                <property name="switchName" value="mzXML"/>
                                            </bean>
                                            <bean class="org.labkey.api.pipeline.cmd.RequiredSwitch">
                                                <property name="switchName" value="32"/>
                                            </bean>
                                            <bean class="org.labkey.api.pipeline.cmd.RequiredSwitch">
                                                <property name="switchName" value="e"/>
                                                <property name="value" value=".msprefix.mzXML"/>
                                                <property name="switchFormat" ref="unixDefaultSwitch" />
                                            </bean>
                                            <bean class="org.labkey.api.pipeline.cmd.PathInLine">
                                                <property name="key" value="Spectra" />
                                            </bean>
                                        </list>
                                    </property>
                                </bean>
                            </entry>
                        </map>
                    </property>
                </bean>
            </list>
        </property>
    </bean>

    <!-- Utility beans -->
    <bean id="unixNewSwitch" class="org.labkey.api.pipeline.cmd.UnixNewSwitchFormat"/>
    <bean id="unixCompactSwitch" class="org.labkey.api.pipeline.cmd.UnixCompactSwitchFormat"/>
    <bean id="unixDefaultSwitch" class="org.labkey.api.pipeline.cmd.UnixSwitchFormat"/>

    <bean id="mzXMLFileType" class="org.labkey.api.util.FileType">
        <constructor-arg>
            <list>
                <value>.msprefix.mzXML</value>
                <value>.mzXML</value>
            </list>
        </constructor-arg>
        <constructor-arg value=".mzXML"/>
    </bean>
</beans>